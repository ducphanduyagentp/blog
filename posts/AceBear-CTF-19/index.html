<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content=""><meta name="hour-prompt" content=""><meta name="minute-prompt" content=""><meta name="justnow-prompt" content=""><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="AceBear CTF 19" /><meta name="author" content="Duc Phan" /><meta property="og:locale" content="en_US" /><meta name="description" content="I had a lot of fun and a hard time during this CTF, but the challenges are really awesome. I spent the whole time solving one challenge: Incident Response (Misc 1000). In my opinion, this challenge closely resembles a real-life scenario and I’m glad that I’ve learned a lot out of it. So here goes the write up for it!" /><meta property="og:description" content="I had a lot of fun and a hard time during this CTF, but the challenges are really awesome. I spent the whole time solving one challenge: Incident Response (Misc 1000). In my opinion, this challenge closely resembles a real-life scenario and I’m glad that I’ve learned a lot out of it. So here goes the write up for it!" /><link rel="canonical" href="https://ret2.life/posts/AceBear-CTF-19/" /><meta property="og:url" content="https://ret2.life/posts/AceBear-CTF-19/" /><meta property="og:site_name" content="ret2life" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-04-09T06:46:23+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="AceBear CTF 19" /><meta name="twitter:site" content="@flyingpassword" /><meta name="twitter:creator" content="@Duc Phan" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Duc Phan"},"dateModified":"2021-07-24T18:11:18+08:00","datePublished":"2019-04-09T06:46:23+08:00","description":"I had a lot of fun and a hard time during this CTF, but the challenges are really awesome. I spent the whole time solving one challenge: Incident Response (Misc 1000). In my opinion, this challenge closely resembles a real-life scenario and I’m glad that I’ve learned a lot out of it. So here goes the write up for it!","headline":"AceBear CTF 19","mainEntityOfPage":{"@type":"WebPage","@id":"https://ret2.life/posts/AceBear-CTF-19/"},"url":"https://ret2.life/posts/AceBear-CTF-19/"}</script><title>AceBear CTF 19 | ret2life</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ret2life"><meta name="application-name" content="ret2life"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://pbs.twimg.com/profile_images/1417881771534819331/0AuUptMd_400x400.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ret2life</a></div><div class="site-subtitle font-italic">From CTF write-ups to everyday life kind of things</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span></span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/ducphanduyagentp" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/flyingpassword" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['youreallythingimmaputemail','on.here?'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> </a> </span> <span>AceBear CTF 19</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" ></span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>AceBear CTF 19</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Duc Phan </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="2019-04-09 06:46:23 +0800" >2019-04-09 06:46:23 +0800<i class="unloaded">2019-04-09T06:46:23+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="2021-07-24 17:11:18 +0700 " >2021-07-24 17:11:18 +0700 <i class="unloaded">2021-07-24T18:11:18+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1974 ">10 </span></div></div><div class="post-content"><p>I had a lot of fun and a hard time during this CTF, but the challenges are really awesome. I spent the whole time solving one challenge: Incident Response (Misc 1000). In my opinion, this challenge closely resembles a real-life scenario and I’m glad that I’ve learned a lot out of it. So here goes the write up for it!</p><h2 id="memory-forensics---identifying-the-malicious-program">Memory forensics - Identifying the malicious program</h2><p>In this challenge, we’re given a network capture and a memory dump of a Windows machine. Opening up the network capture, we can see that the majority of it is network activity between <code class="language-plaintext highlighter-rouge">192.168.182.136</code> (a local IP address) and <code class="language-plaintext highlighter-rouge">13.229.248.109</code> on port <code class="language-plaintext highlighter-rouge">443</code>. These activities are identified as SSL because it’s on port 443 but there are some data that doesn’t seem to be SSL/TLS, for example: ASCII data at the beginning of packet #13, and there are patterns in most of other packets. This made me think that it’s not really SSL/TLS traffic but custom encrypted data.</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/pcap-1.png" alt="pcap-1" /></p><p>A useful tool for memory forensics is Volatility. Based on the information gathered from the pcap, we can think of looking at network connections in the dump to identify which process was making it.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>vol.py <span class="nt">-f</span> WIN-2VTHJA77HMB-20190313-143547.raw <span class="nt">--profile</span><span class="o">=</span>Win7SP1x86 netscan
...
0x7f8a98d8         TCPv4    192.168.182.136:49158          13.229.248.109:443   ESTABLISHED      1964     explorer.exe   
</pre></table></code></div></div><p>There goes the IP address of the C2 server, and it’s definitely strange that <code class="language-plaintext highlighter-rouge">explorer.exe</code> was making internet connections. This highly indicates that <code class="language-plaintext highlighter-rouge">explorer.exe</code> was injected with malicious code. We can dump the memory of <code class="language-plaintext highlighter-rouge">explorer.exe</code> to find the malicious code if it’s direct injection, or we can examine the DLLs loaded by <code class="language-plaintext highlighter-rouge">explorer.exe</code> if it’s DLL injection. Listing the DLLs, we can see a very suspicious one in an uncommon location</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>$ vol.py -f WIN-2VTHJA77HMB-20190313-143547.raw --profile=Win7SP1x86 dlllist -p 1964
...
0x6eb30000    0x25000        0x1 C:\Users\misc\AppData\Local\Temp\FileProcess.dll
...
</pre></table></code></div></div><p>We can then dump these DLLs using the following command:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ vol.py -f WIN-2VTHJA77HMB-20190313-143547.raw --profile=Win7SP1x86 dlldump -p 1964 -D explorer_dll/
</pre></table></code></div></div><p>Now it’s time for some reverse engineering :)</p><h2 id="reverse-engineering-the-dll">Reverse engineering the DLL</h2><p>This is probably the hardest part. Now that we’ve identified the malicious code, we need to figure out how it encrypts the data, and the flag is probably in the decrypted data. From the network capture, we can see that traffic mostly comes from the client so there is exfiltration going on. These are good hints to identify possible API imports in the DLL:</p><ul><li><code class="language-plaintext highlighter-rouge">CryptDecrypt</code>, <code class="language-plaintext highlighter-rouge">CryptEncrypt</code> and other crypto APIs<li><code class="language-plaintext highlighter-rouge">socket</code>, <code class="language-plaintext highlighter-rouge">connect</code>, <code class="language-plaintext highlighter-rouge">send</code> to communicate over the network</ul><h3 id="21-first-glance---static-analysis">2.1. First glance - static analysis</h3><p>Opening the binary in IDA, we can already see some of these imports. We arrive at the <code class="language-plaintext highlighter-rouge">DllMain</code> function and there’s the call to <code class="language-plaintext highlighter-rouge">loc_6EB32960</code>. However, this is not a function and IDA failed to identify this as a function. This is the first time that I’ve ever dealt with anti-disassembly and it’s quite interesting to know how this works. If you go to the code being called above and keep going down a little bit, you’ll see an instruction highlighted in red at <code class="language-plaintext highlighter-rouge">6EB32A25</code>. The strange thing is right before that, there a jump to <code class="language-plaintext highlighter-rouge">6EB32A25 + 1</code>, so this can’t be the correct disassembly.</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/anti-disassembly-1.png" alt="anti-disassembly-1" /></p><p>Hitting P to create a function at <code class="language-plaintext highlighter-rouge">6EB32960</code> failed, so to fix this, I undefined the instruction highlighted in red, click on <code class="language-plaintext highlighter-rouge">6EB32A26</code> (<code class="language-plaintext highlighter-rouge">6EB32A25 + 1</code>), pressed C to define this as code and patched the only byte left as nop. Now we can go back to the function prologue and hit P again to define a function. Worked like a charm! At that point, I still wasn’t sure if this would impact the code being run, but it’s nice to be able to see the code in graph mode, so I went on and fix all the remaining failed disassembly using this method. There are a few places with random bytes (indicated by the <code class="language-plaintext highlighter-rouge">db</code> instruction) that you can also nop out to fix the disassembly.</p><p>There’s a few things worth noting in this start function:</p><ul><li>There are stack strings which looks like base64, but decrypting it yields no readable ascii. <img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/base64.png" alt="base64" /><li>It gathers some system information and writing it to <code class="language-plaintext highlighter-rouge">sysinfo</code>.<li>It creates 3 threads of functions at the following locations: <code class="language-plaintext highlighter-rouge">6EB31AE0</code> (Thread1), <code class="language-plaintext highlighter-rouge">6EB31D70</code> (Thread2) and <code class="language-plaintext highlighter-rouge">6EB32230</code> (Thread3)<ul><li><code class="language-plaintext highlighter-rouge">Thread1</code> contains more stack strings and call APIs such as <code class="language-plaintext highlighter-rouge">GetDC</code>, <code class="language-plaintext highlighter-rouge">GetCompatibleBitmap</code>, <code class="language-plaintext highlighter-rouge">BitBlt</code>, which indicates that it may be taking screenshots.<li><code class="language-plaintext highlighter-rouge">Thread2</code> makes networking APIs call such as <code class="language-plaintext highlighter-rouge">htons</code>, <code class="language-plaintext highlighter-rouge">socket</code>, <code class="language-plaintext highlighter-rouge">connect</code>, <code class="language-plaintext highlighter-rouge">send</code>.<li><code class="language-plaintext highlighter-rouge">Thread3</code> also makes networking APIs call including <code class="language-plaintext highlighter-rouge">inet_addr</code>. This can be where the C2 IP address is saved.</ul></ul><p>Diving more into these functions, I figured out more important functions:</p><ul><li><code class="language-plaintext highlighter-rouge">sub_6EB31050</code>: basically sprintf<li><code class="language-plaintext highlighter-rouge">sub_6EB31090</code>: Write a screenshot to a file.<li><code class="language-plaintext highlighter-rouge">sub_6EB31360</code>: A base64 encode/decode function.<li><code class="language-plaintext highlighter-rouge">sub_6EB31560</code>: Get the current process name<li><code class="language-plaintext highlighter-rouge">sub_6EB31620</code>: A decryption function<li><code class="language-plaintext highlighter-rouge">sub_6EB31820</code>: Send file over the network<li><code class="language-plaintext highlighter-rouge">sub_6EB32180</code>: Run a reverse shell<li><code class="language-plaintext highlighter-rouge">sub_6EB32360</code>: The action is taken based on global boolean variables.<ul><li>Get the IP address of the C2 server and save it into a global variable at <code class="language-plaintext highlighter-rouge">6EB518A0</code>. Get the screen sizes and also store it in global variables.<li>Open directories containing “AppData” in the path.<li>Perform some cryptographic operations.</ul></ul><p>How did I discover those functions? I basically looking at return values from API calls that are stored in global variables and how those global variables are used. For example:</p><ul><li><code class="language-plaintext highlighter-rouge">Thread3</code> opens a socket and saves it to a global variable at <code class="language-plaintext highlighter-rouge">6EB50948</code>. Right after that, a function is called and it uses this socket along with the <code class="language-plaintext highlighter-rouge">OpenProcessA</code> API with the parameter to <code class="language-plaintext highlighter-rouge">C:\Windows\System32\cmd.exe</code> (as a stack string).<li>Global boolean variables are used in if statements to make decisions about the actions being performed. Also notes to increment of some variables because they are used as counters across the threads to also make decisions about actions.</ul><p>The descriptions provided above are really superficial because I also made guesses, but they captures the basic actions being performed.</p><p>Now let’s put together the pieces.</p><h3 id="22-putting-them-all-together---dynamic-analysis">2.2. Putting them all together - Dynamic Analysis</h3><p>The tools that I used for dynamic analysis include Procmon, Process Explorer and x64dbg. Debugging the DLLs can be a little bit difficult because it only runs inside <code class="language-plaintext highlighter-rouge">explorer.exe</code>. After trying several ways to inject the DLL into <code class="language-plaintext highlighter-rouge">explorer.exe</code> without any luck, I ended up using the <code class="language-plaintext highlighter-rouge">AppInit_DLLs</code> registry key to load it when <code class="language-plaintext highlighter-rouge">explorer.exe</code> is run.</p><h4 id="221-file-system-activities">2.2.1. File system activities</h4><p>Monitoring file system activities, we can see the folders and files that it’s trying to access. There’s a noticeable amount of activities in <code class="language-plaintext highlighter-rouge">C:\Users\&lt;username&gt;\AppData\Roaming\Microsoft\Explorer\</code> and it’s because it couldn’t find the path. The <code class="language-plaintext highlighter-rouge">Explorer</code> folder wasn’t there! This is related to the function all at the very beginning of the DLL. <code class="language-plaintext highlighter-rouge">sub_6EB32360</code> is called to initialized data such as IP addresses and directory to write data to. For some reasons, the function failed to initialized the data as intended because all the boolean variables that I’ve mentioned previously couldn’t be set. Setting breakpoints at <code class="language-plaintext highlighter-rouge">CreateFile</code> and <code class="language-plaintext highlighter-rouge">WriteFile</code> can reveal the same information in the debugger (which is the actual way that I figured this out.) So I just created the folder myself. If the initialization were successful, a file named <code class="language-plaintext highlighter-rouge">sysinfo</code> would have been in the folder, but it was never in there.</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/procmon1.png" alt="procmon1" /></p><p>After that, it runs that initialization function again and finally creates 3 threads with the 3 functions that we’ve found in static analysis. As mentioned before, <code class="language-plaintext highlighter-rouge">Thread1</code> is responsible for taking screenshots and saving them to files. The filenames are unix timestamps, which can also be observed in the pcap. More details are in the next section.</p><p><strong>Note:</strong> If you encounter the same issue, you will need to create the folder manually. Otherwise, you won’t be able to observe the network traffic because there is no data to be sent.</p><h4 id="222-networking-activities">2.2.2. Networking activities</h4><p>Observing more closely, around the call to <code class="language-plaintext highlighter-rouge">send</code> in <code class="language-plaintext highlighter-rouge">Thread2</code>, we can see the string “1” being copied and a function call to <code class="language-plaintext highlighter-rouge">sub_6EB31820</code>. Inside <code class="language-plaintext highlighter-rouge">sub_6EB31820</code>, we can also see API calls to <code class="language-plaintext highlighter-rouge">send</code> and the string “2”. Going back to the pcap, we can see packets starting with “1” and “2”, so these indicate the data type being sent.</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/sendfile.png" alt="sendfile" /></p><p>There are 2 significant counters that are used: A <code class="language-plaintext highlighter-rouge">SentFileCounter</code> at <code class="language-plaintext highlighter-rouge">6EB51458</code> and a <code class="language-plaintext highlighter-rouge">CurrentFileCounter</code> at <code class="language-plaintext highlighter-rouge">6EB51460</code>. <code class="language-plaintext highlighter-rouge">CurrentFileCounter</code> is incremented in <code class="language-plaintext highlighter-rouge">Thread1</code> every time a screenshot is taken, and <code class="language-plaintext highlighter-rouge">SentFileCounter</code> is incremented whenever a file is sent in <code class="language-plaintext highlighter-rouge">Thread2</code>. When does the data get sent? The data only get sent when the <code class="language-plaintext highlighter-rouge">CurrentFileCounter</code> is at least 5. If the <code class="language-plaintext highlighter-rouge">SentFileCounter</code> reaches <code class="language-plaintext highlighter-rouge">0x12C</code>, a reverse shell is spawned by <code class="language-plaintext highlighter-rouge">Thread3</code>.</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/filecount.png" alt="filecount" /></p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/sentfilecount.png" alt="sentfilecount" /></p><p>It is worth noting that there are 2 separated sockets being used: 1 is for the reverse shell in <code class="language-plaintext highlighter-rouge">Thread3</code> and 1 is for sending the screenshots. Setting breakpoints on <code class="language-plaintext highlighter-rouge">htons</code>, <code class="language-plaintext highlighter-rouge">inet_addr</code>, <code class="language-plaintext highlighter-rouge">socket</code>, <code class="language-plaintext highlighter-rouge">connect</code> and <code class="language-plaintext highlighter-rouge">send</code> will reveal the information being sent over the network. Following are the 2 types of packets being sent that we’ve observed before: one starts with “1” and one starts with “2”.</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/send2.png" alt="send2" /></p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/send1.png" alt="send1" /></p><p>The first packet is the unencrypted filename that we can tell from procmon in the previous section. We still have no idea what the second packet is, but the first few bytes are similar to many of those in the pcap, so this highly indicates that the same encryption key is used.</p><h4 id="223-cryptographic-functions">2.2.3. Cryptographic functions</h4><p>The decryption function is called a lot of times across the program. Setting breakpoints at <code class="language-plaintext highlighter-rouge">CryptDecrypt</code> will just reveal the decrypted data. While debugging, I did notice special strings being passed around.</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/decrypt1.png" alt="decrypt1" /></p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/decrypt2.png" alt="decrypt2" /></p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/decrypt3.png" alt="decrypt3" /></p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/decrypt4.png" alt="decrypt4" /></p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/ip1.png" alt="ip1" /></p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/string1.png" alt="string1" /></p><h4 id="224-adding-everything-up">2.2.4. Adding everything up</h4><p>Now that we know the second type of packet is encrypted, we also have the data that the program generated. Opening up the files in a hex editor, we can see that it’s an unencrypted bitmap image.</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/bitmap1.png" alt="bitmap1" /></p><p>It turns out that the program uses XOR encryption to encrypt the data. The encryption can be observed inside <code class="language-plaintext highlighter-rouge">sub_6EB31820</code> and also by XOR-ing the first few bytes of the encrypted and unencrypted data. The key is stored in a global variable at <code class="language-plaintext highlighter-rouge">6EB51920</code>.</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/xor1.png" alt="xor1" /></p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/xor2.png" alt="xor2" /></p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/xor3.png" alt="xor3" /></p><p>Also notice that there is a huge buffer in this function, which is used to store the data being sent over the network.</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/databuffer.png" alt="databuffer" /></p><p>Now we just need to observe the memory that stores the key and we are able to get it.</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/xorkey.png" alt="databuffer" /></p><p>Notice that the length of sent data is 1028 but the buffer is only 1024, so there is a 4-byte header before the actual data starts. In addition, only the first 8 bytes of the key is used. The job now is to parse all the packets sent to the server from the pcap, identifying the packets of type 2 that we need to decrypt and concat them together and XOR-decrypt them.</p><p>My solution was not able to properly decrypt the packets, but the images still showed up and it was sufficient to see the flag. The images were staggered so I made another script to (somewhat) fix the images. They are still really bad but I was lucky enough to see that flag :D</p><p>Here is the image before fixing:</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/imagebefore.png" alt="imagebefore" /></p><p>And here’s the image after fixing:</p><p><img data-proofer-ignore data-src="/assets/img/acebear-ctf-19/imageafter.png" alt="imageafter" /></p><p>There’s the flag: <code class="language-plaintext highlighter-rouge">AceBear{M3m0ry_f0r3nsic_&amp;_M4lwa3r_an4lysis_i5_cool}</code></p><p>Also if you look carefully, there’s an URL in the picture in Internet Explorer. I tried going to the URL but it was already down at that point: <code class="language-plaintext highlighter-rouge">http://mi5cfl4g.chung96vn.cf/fl4g_mi5c</code></p><p>Full solution can be found here: https://github.com/ducphanduyagentp/ourCTFs/tree/master/2019/acebear-ctf-19/misc/incident-response</p><h2 id="future-improvements">Future improvements</h2><p>There are several things that I can improve in the future and would have saved me a lot of time looking at this challenge:</p><ul><li>A quick way to inject the DLL into the process. I spent many hours debugging <code class="language-plaintext highlighter-rouge">explorer.exe</code> inside x64dbg and just manually loaded the DLL every time, which was really time-consuming.<li>A quick way to patch the bytes used for anti-RE. I should probably learn idapython :)</ul><p>If you have any questions, please feel free to leave a comment below or reach out to me on Twitter. Thanks for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/reversing/'>reversing</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/reversing/" class="post-tag no-text-decoration" >reversing</a> <a href="/tags/malware-analysis/" class="post-tag no-text-decoration" >malware analysis</a> <a href="/tags/memory-forensic/" class="post-tag no-text-decoration" >memory forensic</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1"></span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AceBear CTF 19 - ret2life&url=https://ret2.life/posts/AceBear-CTF-19/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AceBear CTF 19 - ret2life&u=https://ret2.life/posts/AceBear-CTF-19/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=AceBear CTF 19 - ret2life&url=https://ret2.life/posts/AceBear-CTF-19/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="" title-succeed=""> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Google-CTF-2021/">Google CTF 2021 - Fullchain</a><li><a href="/posts/CSAW-CTF-17-Qual/">CSAW CTF 2017 Qualification</a><li><a href="/posts/AceBear-CTF-19/">AceBear CTF 19</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/reversing/">reversing</a> <a class="post-tag" href="/tags/browser/">browser</a> <a class="post-tag" href="/tags/pentest/">pentest</a> <a class="post-tag" href="/tags/radare2/">radare2</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/blue-team/">blue team</a> <a class="post-tag" href="/tags/ccdc/">ccdc</a> <a class="post-tag" href="/tags/chrome/">chrome</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/35C3-CTF/"><div class="card-body"> <span class="timeago small" >Dec 30, 2018<i class="unloaded">2018-12-30T11:01:14+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>35C3 CTF</h3><div class="text-muted small"><p> This is my first time participating in C3 CTF. Although I wasn’t able to solve many challenges within the time of the CTF, I still find the challenges really awesome and exciting. I wanted to solve...</p></div></div></a></div><div class="card"> <a href="/posts/TetCTF-19/"><div class="card-body"> <span class="timeago small" >Jan 1, 2019<i class="unloaded">2019-01-01T14:34:45+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TetCTF 19</h3><div class="text-muted small"><p> This is my write-up for TetCTF 19 Web - IQTest2 (unsolved) Pwn - Easy webserver (unsolved) Pwn - Babysandbox Pwn - Babyheap Pwn - Babyfirst Web IQTest2 After looking at the s...</p></div></div></a></div><div class="card"> <a href="/posts/CSAW-CTF-17-Qual/"><div class="card-body"> <span class="timeago small" >Sep 21, 2017<i class="unloaded">2017-09-21T11:48:01+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CSAW CTF 2017 Qualification</h3><div class="text-muted small"><p> This is the write-up for challenges I have done in CSAW CTF Qualification 2017 pwn: pilot (75 pts.) English version here Vietnamese Năm nay mình có cơ hội chơi CSAW CTF một cách thực sự, với ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Insomnihack-teaser-CTF-2019/" class="btn btn-outline-primary" prompt="Older"><p>Insomnihack Teaser CTF 2019</p></a> <a href="/posts/Google-CTF-2021/" class="btn btn-outline-primary" prompt="Newer"><p>Google CTF 2021 - Fullchain</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Duc Phan</a>.</p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4"></h4><a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/reversing/">reversing</a> <a class="post-tag" href="/tags/browser/">browser</a> <a class="post-tag" href="/tags/pentest/">pentest</a> <a class="post-tag" href="/tags/radare2/">radare2</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/blue-team/">blue team</a> <a class="post-tag" href="/tags/ccdc/">ccdc</a> <a class="post-tag" href="/tags/chrome/">chrome</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WN0BSTHR4X"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WN0BSTHR4X'); }); </script>
